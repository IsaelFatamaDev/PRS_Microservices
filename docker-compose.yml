version: "3.8"

services:
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: jass-rabbitmq
    mem_limit: 250m
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks: [ jass-net ]
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  vg-ms-organizations:
    image: isaelfatamadev/prs_microservices-vg-ms-organizations:latest
    container_name: vg-ms-organizations
    mem_limit: 250m
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MONGODB_URI: mongodb+srv://sistemajass:ZC7O1Ok40SwkfEje@sistemajass.jn6cpoz.mongodb.net/JASS_DIGITAL?retryWrites=true&w=majority&maxPoolSize=10&minPoolSize=2&maxIdleTimeMS=30000&serverSelectionTimeoutMS=3000&heartbeatFrequencyMS=30000
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: admin
      RABBITMQ_PASSWORD: admin
      CLOUDINARY_CLOUD_NAME: drqpwb5rq
      CLOUDINARY_API_KEY: "376462778114431"
      CLOUDINARY_API_SECRET: 47C9YZgGsnXTCEu-yrifnY8NC5E
    networks: [ jass-net ]
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy

  vg-ms-users:
    image: isaelfatamadev/prs_microservices-vg-ms-users:latest
    container_name: vg-ms-users
    mem_limit: 250m
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_HOST: 144.126.140.79
      DB_PORT: "5410"
      DB_NAME: sistemajass
      DB_USER: postgres
      DB_PASSWORD: SistemaJass12
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: admin

    networks: [ jass-net ]
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy

  vg-ms-notifications:
    image: isaelfatamadev/prs_microservices-vg-ms-notifications:latest
    container_name: vg-ms-notifications
    mem_limit: 250m
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MONGODB_URI: mongodb+srv://sistemajass:ZC7O1Ok40SwkfEje@sistemajass.jn6cpoz.mongodb.net/JASS_DIGITAL?retryWrites=true&w=majority&maxPoolSize=10&minPoolSize=2&maxIdleTimeMS=30000&serverSelectionTimeoutMS=3000&heartbeatFrequencyMS=30000
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: admin
      EVOLUTION_API_BASE_URL: http://evolution-apis:8080
      EVOLUTION_API_KEY: JASS_EVOLUTION_KEY_2024
      EVOLUTION_API_INSTANCE: jass-whatsapp
      ORGANIZATIONS_API_BASE_URL: http://vg-ms-organizations:8083

      FRONTEND_URL: https://lab.vallegrande.edu.pe/jass/SistemaJass
    networks: [ jass-net ]
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      evolution-apis:
        condition: service_started

  vg-ms-authentication:
    image: isaelfatamadev/prs_microservices-vg-ms-authentication:latest
    container_name: vg-ms-authentication
    mem_limit: 250m
    environment:
      SPRING_PROFILES_ACTIVE: prod
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_ADMIN_USERNAME: admin
      KEYCLOAK_CLIENT_SECRET: zJgI1QiNFXWiinFgAVfxsbqcF8nlGYLy
    networks: [ jass-net ]
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy

  evolution-apis:
    image: atendai/evolution-api:v1.8.4
    container_name: evolution-apis
    mem_limit: 250m
    ports:
      - "9099:8080"
    environment:
      AUTHENTICATION_API_KEY: "JASS_EVOLUTION_KEY_2024"
      AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES: "true"
      SERVER_PORT: "8080"
      SERVER_TYPE: "http"
      SERVER_URL: "http://localhost:8080"
      DATABASE_ENABLED: "false"
      CACHE_REDIS_ENABLED: "true"
      CACHE_REDIS_URI: "redis://redis:6379/0"
      LOG_LEVEL: "ERROR,WARN,INFO,LOG"
      DEL_INSTANCE: "false"
      STORE_MESSAGES: "true"
      STORE_MESSAGE_UP: "true"
      STORE_CONTACTS: "true"
      STORE_CHATS: "true"
      WEBHOOK_GLOBAL_ENABLED: "false"
      QRCODE_LIMIT: "30"
      QRCODE_COLOR: "#198754"
    volumes:
      - evolution_data:/evolution/instances
      - evolution_store:/evolution/store
    networks: [ jass-net ]
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_started

  redis:
    image: redis:7-alpine
    container_name: jass-redis
    mem_limit: 50m
    restart: unless-stopped
    networks: [ jass-net ]

  vg-ms-gateway:
    image: isaelfatamadev/prs_microservices-vg-ms-gateway:latest
    container_name: vg-ms-gateway
    mem_limit: 250m
    ports:
      - "9095:9095"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      KEYCLOAK_ISSUER_URI: https://lab.vallegrande.edu.pe/auth/realms/sistema-jass
      KEYCLOAK_JWK_URI: https://lab.vallegrande.edu.pe/auth/realms/sistema-jass/protocol/openid-connect/certs
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CORS_ALLOWED_ORIGINS: https://lab.vallegrande.edu.pe
    networks: [ jass-net ]
    restart: unless-stopped
    depends_on:
      - redis
      - vg-ms-authentication
      - vg-ms-organizations
      - vg-ms-users
      - vg-ms-notifications

networks:
  jass-net:
    driver: bridge

volumes:
  rabbitmq_data:
  evolution_data:
  evolution_store:
